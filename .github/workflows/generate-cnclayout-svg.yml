name: Generate CNC Layout SVG

on:
  push:
    branches: [ main, master ]
    paths:
      - 'LifeTrac-v25/mechanical_design/openscad/cnclayout.scad'
      - 'LifeTrac-v25/mechanical_design/openscad/parts/*.scad'
      - 'LifeTrac-v25/mechanical_design/openscad/lifetrac_v25_params.scad'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'LifeTrac-v25/mechanical_design/openscad/cnclayout.scad'
      - 'LifeTrac-v25/mechanical_design/openscad/parts/*.scad'
      - 'LifeTrac-v25/mechanical_design/openscad/lifetrac_v25_params.scad'
  workflow_dispatch:

jobs:
  generate-cnclayout:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # Ensure the workflow checks out the PR branch (not the base branch) for pull_request events
        ref: ${{ github.head_ref || github.ref_name }}
    
    - name: Install OpenSCAD
      run: |
        sudo apt-get update
        sudo apt-get install -y openscad xvfb
    
    - name: Generate Combined CNC Layout SVG
      run: |
        cd LifeTrac-v25/mechanical_design
        
        echo "========================================="
        echo "Generating Combined CNC Layout SVG"
        echo "========================================="
        
        # Use xvfb-run to provide a virtual display for OpenSCAD rendering
        # For 2D projections, use top-down orthographic view
        xvfb-run -a openscad --render \
          --imgsize=4096,8192 \
          --colorscheme=Tomorrow \
          --projection=ortho \
          --camera=0,0,0,0,0,0,3000 \
          -o cnclayout.svg \
          openscad/cnclayout.scad 2>&1 | grep -v "WARNING" || true
        
        # Verify the SVG was created
        if [ -f cnclayout.svg ]; then
          echo "‚úÖ Combined CNC Layout SVG generated successfully"
          ls -lh cnclayout.svg
          du -h cnclayout.svg
          
          # Count paths/shapes in SVG as a sanity check
          echo "Checking SVG content..."
          path_count=$(grep -o "<path" cnclayout.svg | wc -l)
          echo "Number of paths in SVG: ${path_count}"
          
          if [ ${path_count} -gt 50 ]; then
            echo "‚úÖ SVG contains ${path_count} paths (expected 50+)"
          else
            echo "‚ö†Ô∏è  SVG only contains ${path_count} paths - may be incomplete"
          fi
        else
          echo "‚ùå Failed to generate Combined CNC Layout SVG"
          exit 1
        fi
    
    - name: Update README with CNC layout SVG
      run: |
        cd LifeTrac-v25/mechanical_design
        
        # Check if README already has CNC layout section
        if ! grep -q "## CNC Cutting Layout" README.md; then
          echo "Adding CNC layout section to README..."
          
          {
            echo ""
            echo "## CNC Cutting Layout"
            echo ""
            echo "### Combined Layout (All Parts)"
            echo '![CNC Cutting Layout - All Parts](cnclayout.svg)'
            echo ""
            echo "The combined CNC layout includes all 23 sheet metal parts with complete manufacturing details:"
            echo "- Mounting holes with proper clearances"
            echo "- Pivot holes for arm and cylinder connections"
            echo "- Arc slots for cross beam clearance (inner panels)"
            echo "- Lightening holes for weight reduction"
            echo "- Anti-slip hole patterns (standing deck)"
            echo "- All parts properly spaced for efficient cutting"
            echo ""
            echo "**Material Specifications:**"
            echo '- Half-inch (1/2") plate parts: 14 parts total'
            echo '- Quarter-inch (1/4") plate parts: 9 parts total'
            echo ""
          } >> README.md
          echo "‚úì README updated with CNC layout section"
        else
          echo "‚ÑπÔ∏è  README already has CNC layout section"
        fi
    
    - name: Commit and push if changed
      run: |
        cd LifeTrac-v25/mechanical_design
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add cnclayout.svg README.md || true
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          echo "üìù Committing changes..."
          git commit -m "Update combined CNC layout SVG with detailed parts [skip ci]"
          
          # Fetch and rebase to incorporate any remote changes
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "üîÑ Fetching latest changes from branch: ${BRANCH_NAME}..."
          git fetch origin "${BRANCH_NAME}"
          
          echo "üîÑ Rebasing on latest changes..."
          if ! git rebase "origin/${BRANCH_NAME}"; then
            echo "‚ùå Failed to rebase. There may be conflicts."
            echo "Aborting rebase and exiting..."
            git rebase --abort
            exit 1
          fi
          
          echo "üì§ Pushing changes..."
          git push
          echo "‚úÖ Changes pushed successfully"
        fi
