name: OpenSCAD Render and Export

on:
  push:
    paths:
      - 'LifeTrac-v25/mechanical_design/**/*.scad'
      - '.github/workflows/openscad-render.yml'
  pull_request:
    paths:
      - 'LifeTrac-v25/mechanical_design/**/*.scad'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    name: Generate Renders and Outputs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenSCAD
        run: |
          sudo apt-get update
          sudo apt-get install -y openscad xvfb x11-utils
          openscad --version
      
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x16 &
          XVFB_PID=$!
          echo "XVFB_PID=$XVFB_PID" >> $GITHUB_ENV
          
          # Wait for Xvfb to be ready (max 10 seconds)
          for i in {1..10}; do
            if xdpyinfo -display :99 >/dev/null 2>&1; then
              echo "Xvfb is ready on display :99"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Timeout waiting for Xvfb to start"
              exit 1
            fi
            sleep 1
          done
          
          echo "DISPLAY=:99" >> $GITHUB_ENV
      

      - name: Create output directories
        run: |
          cd LifeTrac-v25/mechanical_design
          mkdir -p output/{dxf,renders,animations}
      
      - name: Generate assembly.png and cnclayout.svg
        run: |
          cd LifeTrac-v25/mechanical_design
          
          # Generate assembly.png (1024x768 matching CEB-Press example)
          echo "Generating assembly.png..."
          openscad -o assembly.png \
            --camera=3000,3000,2000,0,0,500 \
            --imgsize=1024,768 \
            --projection=p \
            --colorscheme=Nature \
            openscad/lifetrac_v25.scad
          
          # Generate cnclayout.svg (2D projection for CNC cutting)
          echo "Generating cnclayout.svg..."
          openscad -o cnclayout.svg \
            --projection=o \
            --viewall \
            cnclayout.scad
          
          echo "âœ“ assembly.png and cnclayout.svg generated successfully"
          ls -lh assembly.png cnclayout.svg
      
      - name: Render preview images
        run: |
          cd LifeTrac-v25/mechanical_design
          
          # Main assembly view
          echo "Rendering main assembly..."
          openscad -o output/renders/lifetrac_v25_main.png \
            --camera=3000,3000,2000,0,0,500 \
            --imgsize=1920,1080 \
            --projection=p \
            --colorscheme=Nature \
            openscad/lifetrac_v25.scad
          
          # Front view
          echo "Rendering front view..."
          openscad -o output/renders/lifetrac_v25_front.png \
            --camera=0,3000,1000,0,0,500 \
            --imgsize=1920,1080 \
            --projection=p \
            --colorscheme=Nature \
            openscad/lifetrac_v25.scad
          
          # Side view
          echo "Rendering side view..."
          openscad -o output/renders/lifetrac_v25_side.png \
            --camera=3000,0,1000,0,0,500 \
            --imgsize=1920,1080 \
            --projection=p \
            --colorscheme=Nature \
            openscad/lifetrac_v25.scad
          
          # Top view
          echo "Rendering top view..."
          openscad -o output/renders/lifetrac_v25_top.png \
            --camera=0,0,3000,0,0,500 \
            --imgsize=1920,1080 \
            --projection=o \
            --colorscheme=Nature \
            openscad/lifetrac_v25.scad
          
          echo "Preview images rendered successfully"
      
      - name: Render module examples
        run: |
          cd LifeTrac-v25/mechanical_design
          
          # Render each module's example
          for module in modules/*.scad; do
            filename=$(basename "$module" .scad)
            echo "Rendering $filename examples..."
            openscad -o "output/renders/${filename}_examples.png" \
              --camera=500,500,500,0,0,0 \
              --imgsize=1600,900 \
              --projection=p \
              --colorscheme=Nature \
              "$module"
          done
      
      - name: Generate animation frames
        run: |
          cd LifeTrac-v25/mechanical_design
          
          echo "Generating animation frames..."
          mkdir -p output/animations/frames
          
          # Generate 36 frames for animation (every 10 degrees)
          for i in {0..35}; do
            t=$(awk "BEGIN {print $i/36}")
            printf "Frame %d (t=%.4f)\n" $i $t
            openscad -o "output/animations/frames/frame_$(printf %03d $i).png" \
              --camera=3000,3000,2000,0,0,500 \
              --imgsize=1280,720 \
              --projection=p \
              --colorscheme=Nature \
              -D "\$t=$t" \
              openscad/lifetrac_v25.scad
          done
          
          echo "Animation frames generated"
      
      - name: Create animation GIF
        run: |
          sudo apt-get install -y imagemagick
          cd LifeTrac-v25/mechanical_design/output/animations
          
          echo "Creating animation GIF of arm movement..."
          convert -delay 10 -loop 0 frames/frame_*.png lifetrac_v25_animation.gif
          
          # Copy to parent directory for easy access
          cp lifetrac_v25_animation.gif ../../lifetrac_v25_animation.gif
          
          echo "âœ“ Animation GIF created successfully"
          ls -lh ../../lifetrac_v25_animation.gif
      
      - name: Generate summary report
        run: |
          cd LifeTrac-v25/mechanical_design
          
          cat > output/RENDER_REPORT.md << 'EOF'
          # OpenSCAD Render Report
          
          **Generated:** $(date)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## Files Generated
          
          ### Preview Renders
          - Main assembly view
          - Front view
          - Side view
          - Top view
          - Module examples (5 modules)
          
          ### Animations
          - 36 animation frames (1280x720 PNG)
          - Animated GIF showing arm movement (lifetrac_v25_animation.gif)
          
          ### CNC Files
          - assembly.png (3D render of complete assembly)
          - cnclayout.svg (2D layout for CNC cutting)
          
          ## Next Steps
          
          1. Review rendered images in the artifacts
          2. View lifetrac_v25_animation.gif to see arm movement
          3. Use cnclayout.svg for CNC plasma cutting
          4. Use animation frames to create videos
          5. Export DXF files for individual parts using export_all_cnc_parts.sh
          6. Check the Structural Analysis workflow for design validation results
          
          ---
          Generated by GitHub Actions
          EOF
      
      - name: Upload render artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openscad-renders
          path: |
            LifeTrac-v25/mechanical_design/output/renders/
            LifeTrac-v25/mechanical_design/output/RENDER_REPORT.md
          retention-days: 90
      
      - name: Upload animation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openscad-animations
          path: LifeTrac-v25/mechanical_design/output/animations/
          retention-days: 90
      
      - name: Commit and push rendered outputs
        run: |
          cd LifeTrac-v25/mechanical_design
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add the generated files
          git add assembly.png cnclayout.svg lifetrac_v25_animation.gif
          
          # Check if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "Update rendered outputs (assembly, layout, animation) [skip ci]"
            git push --force-with-lease origin HEAD || {
              echo "INFO: git push failed. This is expected on PRs from forks."
              echo "The files are available as workflow artifacts."
            }
          else
            echo "No changes to rendered output files"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup Xvfb
        if: always()
        run: |
          if [ -n "$XVFB_PID" ]; then
            echo "Stopping Xvfb process (PID: $XVFB_PID)"
            # Try graceful shutdown first
            kill -TERM $XVFB_PID 2>/dev/null || true
            # Wait up to 5 seconds for process to terminate
            for i in {1..5}; do
              if ! kill -0 $XVFB_PID 2>/dev/null; then
                echo "Xvfb stopped gracefully"
                break
              fi
              sleep 1
            done
            # Force kill if still running
            kill -KILL $XVFB_PID 2>/dev/null || true
            echo "Xvfb force stopped"
          fi
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = `## OpenSCAD Render Results ğŸ¨
            
            âœ… Rendering completed successfully!
            
            ### Generated Outputs
            - ğŸ“¸ Preview renders (main, front, side, top views)
            - ğŸ¬ Animation frames (36 frames)
            - ğŸï¸ Animated GIF of arm movement (lifetrac_v25_animation.gif)
            - ğŸ”§ Module examples
            - ğŸ–¼ï¸ Assembly image and CNC layout (assembly.png, cnclayout.svg)
            
            ### Artifacts
            Download the generated files from the workflow artifacts:
            - \`openscad-renders\` - Preview images
            - \`openscad-animations\` - Animation frames and GIF
            
            ### Committed Files
            The following files have been committed to the repository:
            - \`assembly.png\` - 3D assembly render
            - \`cnclayout.svg\` - 2D CNC cutting layout
            - \`lifetrac_v25_animation.gif\` - Animation showing arm movement
            
            _Note: Check the **OpenSCAD Structural Analysis** workflow for design validation and structural analysis results._
            
            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
